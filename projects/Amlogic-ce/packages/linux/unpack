#!/bin/sh

. config/options

$SCRIPTS/install make
$SCRIPTS/install sed

LINUX=`ls -d $PKG_BUILD`
PKG_DIR=`find $PACKAGES -type d -name $1`

make -C $LINUX ARCH=$TARGET_ARCH INSTALL_HDR_PATH=dest headers_install

if [ -f $PROJECT_DIR/$PROJECT/$1/$1.$TARGET_ARCH.conf ]; then
  KERNEL_CFG_FILE=$PROJECT_DIR/$PROJECT/$1/$1.$TARGET_ARCH.conf
else
  KERNEL_CFG_FILE=$PKG_DIR/config/$1.$TARGET_ARCH.conf
fi

sed -i -e "s|^HOSTCC[[:space:]]*=.*$|HOSTCC = $HOST_CC|" \
       -e "s|^HOSTCXX[[:space:]]*=.*$|HOSTCXX = $HOST_CXX|" \
       -e "s|^ARCH[[:space:]]*?=.*$|ARCH = $TARGET_ARCH|" \
       -e "s|^CROSS_COMPILE[[:space:]]*?=.*$|CROSS_COMPILE = $TARGET_PREFIX|" \
       $LINUX/Makefile

cp $KERNEL_CFG_FILE $LINUX/.config
sed -i -e "s|^CONFIG_INITRAMFS_SOURCE=.*$|CONFIG_INITRAMFS_SOURCE=\"$ROOT/$PKG_DIR/config/initramfs\"|" \
  $LINUX/.config

 if [ "$DEVTOOLS" = yes ]; then
   echo "CONFIG_KALLSYMS=y" >> $LINUX/.config
   echo "CONFIG_KALLSYMS_EXTRA_PASS=y" >> $LINUX/.config
   echo "# CONFIG_KALLSYMS_ALL is not set" >> $LINUX/.config
   echo "# CONFIG_KPROBES is not set" >> $LINUX/.config
 fi

make -C $LINUX oldconfig
