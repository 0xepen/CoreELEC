#!/bin/sh

. config/options

$SCRIPTS/install make
$SCRIPTS/install sed

LINUX=`ls -d $PKG_BUILD`
PKG_DIR=`find $PACKAGES -type d -name $1`

make -C $LINUX ARCH=$TARGET_ARCH INSTALL_HDR_PATH=dest headers_install

if [ -f $PROJECT_DIR/$PROJECT/$1/$1.$TARGET_ARCH.conf ]; then
  KERNEL_CFG_FILE=$PROJECT_DIR/$PROJECT/$1/$1.$TARGET_ARCH.conf
else
  KERNEL_CFG_FILE=$PKG_DIR/config/$1.$TARGET_ARCH.conf
fi

sed -i -e "s|^HOSTCC[[:space:]]*=.*$|HOSTCC = $HOST_CC|" \
       -e "s|^HOSTCXX[[:space:]]*=.*$|HOSTCXX = $HOST_CXX|" \
       -e "s|^ARCH[[:space:]]*?=.*$|ARCH = $TARGET_ARCH|" \
       -e "s|^CROSS_COMPILE[[:space:]]*?=.*$|CROSS_COMPILE = $TARGET_PREFIX|" \
       $LINUX/Makefile

cp $KERNEL_CFG_FILE $LINUX/.config
sed -i -e "s|^CONFIG_INITRAMFS_SOURCE=.*$|CONFIG_INITRAMFS_SOURCE=\"$ROOT/$PKG_DIR/config/initramfs\"|" \
  $LINUX/.config

  if [ "$DEVTOOLS" = yes ]; then
    echo "CONFIG_KALLSYMS=y" >> $LINUX/.config
    echo "CONFIG_KALLSYMS_EXTRA_PASS=y" >> $LINUX/.config
    echo "# CONFIG_KALLSYMS_ALL is not set" >> $LINUX/.config
    echo "# CONFIG_KPROBES is not set" >> $LINUX/.config
    echo "CONFIG_DEBUG_KERNEL=y" >> $LINUX/.config # needed for bootchart
    echo "CONFIG_SCHEDSTATS=y" >> $LINUX/.config # needed for bootchart
    echo "CONFIG_SCHED_DEBUG=y" >> $LINUX/.config # needed for bootchart
    echo "# CONFIG_DEBUG_PERF_USE_VMALLOC is not set" >> $LINUX/.config
    echo "# CONFIG_PCI_DEBUG is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_DRIVER is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_DEVRES is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_SHIRQ is not set" >> $LINUX/.config
    echo "# CONFIG_DETECT_SOFTLOCKUP is not set" >> $LINUX/.config
    echo "# CONFIG_DETECT_HUNG_TASK is not set" >> $LINUX/.config
    echo "# CONFIG_TIMER_STATS is not set" >> $LINUX/.config 
    echo "# CONFIG_DEBUG_OBJECTS is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_KMEMLEAK is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_RT_MUTEXES is not set" >> $LINUX/.config
    echo "# CONFIG_RT_MUTEX_TESTER is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_SPINLOCK is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_MUTEXES is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_LOCK_ALLOC is not set" >> $LINUX/.config
    echo "# CONFIG_PROVE_LOCKING is not set" >> $LINUX/.config
    echo "# CONFIG_LOCK_STAT is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_SPINLOCK_SLEEP is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_LOCKING_API_SELFTESTS is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_KOBJECT is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_HIGHMEM is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_INFO is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_VM is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_VIRTUAL is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_WRITECOUNT is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_LIST is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_SG is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_NOTIFIERS is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_CREDENTIALS is not set" >> $LINUX/.config
    echo "# CONFIG_BOOT_PRINTK_DELAY is not set" >> $LINUX/.config
    echo "# CONFIG_RCU_TORTURE_TEST is not set" >> $LINUX/.config
    echo "# CONFIG_BACKTRACE_SELF_TEST is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_BLOCK_EXT_DEVT is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_FORCE_WEAK_PER_CPU is not set" >> $LINUX/.config
    echo "# CONFIG_FAULT_INJECTION is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_PAGEALLOC is not set" >> $LINUX/.config
    echo "# CONFIG_KGDB is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_STACKOVERFLOW is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_STACK_USAGE is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_PER_CPU_MAPS is not set" >> $LINUX/.config
    echo "# CONFIG_X86_PTDUMP is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_RODATA is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_NX_TEST is not set" >> $LINUX/.config
    echo "# CONFIG_CPA_DEBUG is not set" >> $LINUX/.config
    echo "# CONFIG_DEBUG_STRICT_USER_COPY_CHECKS is not set" >> $LINUX/.config
    echo "# CONFIG_MAXSMP is not set" >> $LINUX/.config
    echo "# CONFIG_IOMMU_DEBUG is not set" >> $LINUX/.config
  fi

make -C $LINUX oldconfig
