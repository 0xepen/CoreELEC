---
 include/linux/swap.h |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6.37-ck2/include/linux/swap.h
===================================================================
--- linux-2.6.37-ck2.orig/include/linux/swap.h	2011-01-06 14:04:10.000000000 +1100
+++ linux-2.6.37-ck2/include/linux/swap.h	2011-02-14 10:11:00.763252001 +1100
@@ -348,9 +348,10 @@
 extern void grab_swap_token(struct mm_struct *);
 extern void __put_swap_token(struct mm_struct *);
 
+/* Only allow swap token to have effect if swap is full */
 static inline int has_swap_token(struct mm_struct *mm)
 {
-	return (mm == swap_token_mm);
+	return (mm == swap_token_mm && vm_swap_full());
 }
 
 static inline void put_swap_token(struct mm_struct *mm)
