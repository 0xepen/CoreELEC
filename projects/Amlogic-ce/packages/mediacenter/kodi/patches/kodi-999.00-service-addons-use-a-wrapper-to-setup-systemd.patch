From 6746387ee5681508c40a8d02747f9c1f3a7cdbc2 Mon Sep 17 00:00:00 2001
From: Stefan Saraev <stefan@saraev.ca>
Date: Fri, 8 Aug 2014 18:22:44 +0300
Subject: [PATCH] use a wrapper to setup systemd services

---
 xbmc/addons/Service.cpp | 12 ++++++++++++
 xbmc/addons/Service.h   |  3 +++
 2 files changed, 15 insertions(+)

diff --git a/xbmc/addons/Service.cpp b/xbmc/addons/Service.cpp
index c406b11..808f498 100644
--- a/xbmc/addons/Service.cpp
+++ b/xbmc/addons/Service.cpp
@@ -53,6 +53,7 @@ AddonPtr CService::Clone() const
 bool CService::Start()
 {
   bool ret = true;
+
   switch (m_type)
   {
 #ifdef HAS_PYTHON
@@ -113,13 +114,24 @@ void CService::BuildServiceType()
   }
 }
 
+void CService::CallOEWrapper(const std::string& ID, bool disable)
+{
+  char cmd[255];
+  snprintf(cmd, sizeof(cmd), "/usr/lib/openelec/systemd-addon-wrapper %s %d", ID.c_str(), disable);
+  system(cmd);
+}
+
 void CService::OnDisabled()
 {
+  CallOEWrapper(ID(), true);
+
   Stop();
 }
 
 void CService::OnEnabled()
 {
+  CallOEWrapper(ID(), false);
+
   Start();
 }
 
diff --git a/xbmc/addons/Service.h b/xbmc/addons/Service.h
index 98ec8b6..36e4109 100644
--- a/xbmc/addons/Service.h
+++ b/xbmc/addons/Service.h
@@ -47,6 +47,9 @@ namespace ADDON
     bool Stop();
     TYPE GetServiceType() { return m_type; }
     START_OPTION GetStartOption() { return m_startOption; }
+
+    void CallOEWrapper(const std::string& ID, bool disable);
+
     virtual void OnDisabled();
     virtual void OnEnabled();
     virtual bool OnPreInstall();
-- 
2.1.0

